//  gamma-analyzer-3d - 3d visualization of sessions generated by gamma-analyzer
//  Copyright (C) 2017  Dag Robole
//
//  This program is free software: you can redistribute it and/or modify
//  it under the terms of the GNU General Public License as published by
//  the Free Software Foundation, either version 3 of the License, or
//  (at your option) any later version.
//
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//  GNU General Public License for more details.
//
//  You should have received a copy of the GNU General Public License
//  along with this program.  If not, see <http://www.gnu.org/licenses/>.

#include "gamman3d.h"
#include "geo.h"
#include <stdexcept>
#include <QMessageBox>
#include <QFileDialog>
#include <QIcon>
#include <QDebug>

using namespace QtDataVisualization;

gamman3d::gamman3d(QWidget *parent) :
    QMainWindow(parent),
    gui(new Gui()),
    session(new gamma::Session())
{        
    gui->setup(this);
    setupSignals();    
}

gamman3d::~gamman3d()
{
    try
    {
        delete session;
        delete gui;
    }
    catch(const std::exception& e)
    {
        qDebug() << e.what();
    }
}

void gamman3d::setupSignals()
{    
    QObject::connect(gui->actionOpenSession, &QAction::triggered,
            this, &gamman3d::openSession);

    QObject::connect(gui->actionCloseSession, &QAction::triggered,
            this, &gamman3d::closeSession);        

    QObject::connect(gui->actionExit, &QAction::triggered,
            this, &QWidget::close);    

    QObject::connect(gui->comboScatterTheme, SIGNAL(currentIndexChanged(int)),
            this, SLOT(changeSceneTheme(int)));

    QObject::connect(gui->sliderScatterNodeSize, &QSlider::valueChanged,
            this, &gamman3d::resizeSceneNode);

    QObject::connect(gui->scatterSeries, &QScatter3DSeries::selectedItemChanged,
            this, &gamman3d::sceneNodeSelected);
}

void gamman3d::openSession()
{    
    try
    {
        QString dir = QDir::toNativeSeparators(QFileDialog::getExistingDirectory(
                    this,
                    tr("Open session directory"),
                    QStringLiteral(""),
                    QFileDialog::ShowDirsOnly |
                    QFileDialog::DontResolveSymlinks));
        if(dir.isEmpty())
            return;

        using namespace gamma;

        session->clear();
        switch(session->load(dir))
        {
        case Session::LoadResult::DirDoesNotExist:
            QMessageBox::information(
                        this, tr("Information"),
                        QStringLiteral("Directory does not exist"));
            return;

        case Session::LoadResult::DirNotASession:
            QMessageBox::information(
                        this, tr("Information"),
                        QStringLiteral("Directory does not appear to be a valid session"));
            return;

        case Session::LoadResult::InvalidSpectrumFound:
            QMessageBox::information(
                        this, tr("Information"),
                        QStringLiteral("Session contains invalid spectrums"));
            break;

        default:
            break;
        }

        populateScene();
        gui->labelStatus->setText(QStringLiteral("Session: ") + dir);
    }
    catch(std::exception &e)
    {
        QMessageBox::warning(this, tr("Error"), e.what());
        return;
    }
}

void gamman3d::closeSession()
{
    try
    {
        session->clear();
        gui->scatterData->clear();
        gui->scatterSeries->dataProxy()->resetArray(gui->scatterData);
        gui->labelStatus->setText("");
    }
    catch(const std::exception& e)
    {
        qDebug() << e.what();
    }
}

void gamman3d::populateScene()
{        
    gui->scatterData->clear();
    gui->scatterData->resize(session->SpectrumCount());
    QScatterDataItem *p = &gui->scatterData->first();
    double x, y, z;

    for(const auto& spec : session->getSpectrums())
    {        
        geo::geodeticToCartesianSimplified(
                    spec->latitudeStart,
                    spec->longitudeStart,
                    x, y, z);                

        p->setPosition(QVector3D(x, spec->altitudeStart, y));
        p++;
    }

    gui->scatterSeries->dataProxy()->resetArray(gui->scatterData);
}

void gamman3d::resizeSceneNode(int val)
{
    gui->scatterSeries->setItemSize((double)val / 20.0);
}

void gamman3d::changeSceneTheme(int theme)
{
    gui->scatter->activeTheme()->setType(Q3DTheme::Theme(theme));
}

void gamman3d::sceneNodeSelected(int idx)
{
    if(idx < 0)
    {
        gui->labelSurfaceLatitude->setText("");
        gui->labelSurfaceLongitude->setText("");
        return;
    }

    if((unsigned int)idx >= session->getSpectrums().size())
        return; // FIXME: report error

    const gamma::Spectrum* spec = session->getSpectrum(idx);
    gui->labelSurfaceLatitude->setText(QString::number(spec->latitudeStart));
    gui->labelSurfaceLongitude->setText(QString::number(spec->longitudeStart));
}
